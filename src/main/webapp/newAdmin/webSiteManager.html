<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>网址信息管理</title>
    <link rel="stylesheet" href="/static/layui/css/layui.css">
    <script src="/static/layui/layui.js"></script>
    <script src="/static/js/jquery.js"></script>
    <link rel="stylesheet" href="../static/css/index.css">
</head>
<body style="border: 10px">
<div class="demoTable">
    搜索网站名称：
    <div class="layui-inline">
        <input class="layui-input" name="name" id="demoReload1" autocomplete="off">
    </div>
    搜索网站地址：
    <div class="layui-inline">
        <input class="layui-input" name="url" id="demoReload2" autocomplete="off">
    </div>
    <button class="layui-btn layui-bg-blue" data-type="reload" id="search">搜索</button>
    <div class="layui-btn-group demoTableSon">
        <button class="layui-btn" data-type="addWebSite" id="addWebSite">添加</button>
        <button class="layui-btn layui-btn-danger" data-type="deleteByIds" id="deleteByIds">删除</button>
    </div>
</div>
<table class="layui-hide" id="test" lay-filter="table"></table>
<script type="text/html" id="barDemo">
    <a class="layui-btn layui-btn-xs" lay-event="edit">编辑</a>
    <a class="layui-btn layui-btn-danger layui-btn-xs" lay-event="del">删除</a>
</script>
<script type="text/html" id="urlTpl">
    <a href="{{d.url}}" target="_blank">{{d.url}}</a>
</script>

<form class="layui-form layui-form-pane" id="webSiteForm" style="margin-right: 20px;margin-top: 20px">

    <div class="layui-form-item">
        <label class="layui-form-label">链接名称</label>
        <div class="layui-input-block">
            <input type="text" name="name" id="name" required  lay-verify="required" placeholder="请输入网址名称" autocomplete="off" class="layui-input">
        </div>
    </div>

    <div class="layui-form-item">
        <label class="layui-form-label">网站地址</label>
        <div class="layui-input-block">
            <input type="text" name="url" id="url" required  lay-verify="url" placeholder="请输入网站地址" autocomplete="off" class="layui-input">
        </div>
    </div>

    <div class="layui-form-item">
        <div class="layui-input-block">
            <button class="layui-btn" lay-submit lay-filter="addWebSite">立即提交</button>
            <button type="reset" class="layui-btn layui-btn-primary">重置</button>
        </div>
    </div>
</form>


<script type="text/javascript">
    $("#webSiteForm").hide();

    layui.use(['layer','form','table'],function () {
        var layer = layui.layer,
            form = layui.form,
            table = layui.table;

        table.render({
            elem:"#test",
            url:"/admin/webSite/webSiteList",
            width:720,
            height:300,
            cols:[[
                {type:'checkbox'},
                {field:'id',title:'编号',width:70,align:'center'},
                {field:'name',title:'网站名称',width:200},
                {field:'url',title:'网站地址',width:200,templet: '#urlTpl'},//绑定tpl表达式
                {title: '操作', width:180, align:'center', toolbar: '#barDemo'}
            ]],
            page:true,//开启分页
            id:'testReload', //这个id挺重要的  你对table做操作时候需要使用到  比如reload的时候
            limits:[5,10,15,20],
            limit:5
        });

        table.on('tool(table)',function (obj) {
            var data = obj.data;
            var id = data.id;
            console.log(id);
            var layEvent = obj.event;
            if(layEvent == "del"){
                var index = layer.confirm("您确定要删除这行数据吗？",function (index) {
                    $.ajax({
                        async:false,
                        cache:false,
                        url:'/admin/webSite/deleteById',
                        type:'POST',
                        dataType:'json',
                        data:{id:id},
                        success:function (result) {
                            if (result.success){
                                obj.del();
                                layer.close(index);
                                layer.msg("系统提示，删除成功",{icon:6});
                            } else{
                                layer.msg("系统提示，删除失败",{icon:6});
                            }
                        },
                        error:function (XMLHttpRequest, textStatus) {
                            layer.alert("状态码: "+XMLHttpRequest.status +" 错误信息: "+ textStatus);
                        }
                    });
                });
            }else if(layEvent == "edit"){
                index = layer.open({
                    type:1,
                    title:'编辑网址信息',
                    shadeClose: true,
                    shade: false,
                    maxmin: true, //开启最大化最小化按钮
                    area: ['400px', '350px'],
                    content: $('#webSiteForm'),
                    end:function () {
                        $("#prependId").remove();
                    }
                });
                $("form").prepend(
                    "<div id='prependId'>\n"+
                    "<div class=\"layui-form-item \">\n" +
                    "            <label class=\"layui-form-label\">编号</label>\n" +
                    "            <div class=\"layui-input-block\">\n" +
                    "                <input type=\"text\" name=\"id\" id=\"id\" required  lay-verify=\"required\" placeholder=\"请输入id\" autocomplete=\"off\" class=\"layui-input\" readonly>\n" +
                    "            </div>\n" +
                    "        </div>\n" +
                    "</div>"
                );
                $("#id").val(data.id);
                $("#name").val(data.name);
                $("#url").val(data.url);
            }
        });

        form.on('submit(addWebSite)',function (data) {
            $.ajax({
                async:false,
                cache:false,
                url:'/admin/webSite/save',
                type:'POST',
                dataType:'json',
                data:data.field,
                success:function (result) {
                    if(result.success){
                        layer.close(index);
                        table.reload('testReload');
                        parent.layer.msg("系统提示，操作成功", { icon: 6 });
                    }else{
                        parent.layer.msg("系统提示，添加失败，请联系管理员", { icon: 5});
                    }
                },
                error:function (XMLHttpRequest, textStatus) {
                    layer.alert("状态码: "+XMLHttpRequest.status +" 错误信息: "+ textStatus);
                }
            });
        });

        $("#addWebSite").on('click',function () {
            index = layer.open({
                type:1,
                title:'添加网址信息',
                shadeClose:true,
                shade:false,
                maxmin:true,
                area: ['400px', '350px'],
                content: $('#webSiteForm')
            });
        });

        var active = {

            reload : function () {
                var demoReload1 = $('#demoReload1').val();
                var demoReload2 = $('#demoReload2').val();
                table.reload('testReload',{
                    page:{
                        curr:1
                    },
                    where:{
                        name:demoReload1,
                        url:demoReload2
                    }
                });
            },

            deleteByIds: function () {
                var checkStatus =  table.checkStatus('testReload');
                var data = checkStatus.data;
                var strIds = [];
                for(var i=0;i<data.length;i++){
                    strIds.push(data[i].id)
                }
                var ids = strIds.join(",");
                console.log(ids);
                layer.confirm("您确定要删除这"+data.length+"条数据吗？",function (index) {
                    $.ajax({
                        async:false,
                        cache:false,
                        url:'/admin/webSite/delete',
                        type:'POST',
                        dataType:'json',
                        data:{ids:ids},
                        success:function (result) {
                            if(result.success){
                                layer.close(index);
                                table.reload('testReload');
                                parent.layer.msg("系统提示，操作成功", { icon: 6 });
                            }else{
                                parent.layer.msg("系统提示，添加失败，请联系管理员", { icon: 5});
                            }
                        },
                        error:function (XMLHttpRequest, textStatus) {
                            layer.alert("状态码: "+XMLHttpRequest.status +" 错误信息: "+ textStatus);
                        }
                    });
                });
            }
        };

        $('#search').on('click',function () {
            var type = $(this).data('type');
            active[type] ? active[type].call(this) : '';
        });

        $('#deleteByIds').on('click',function () {
            var type = $(this).data('type');
            active[type] ? active[type].call(this) : '';
        });

    });
</script>
</body>
</html>
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>电影信息管理</title>
    <link rel="stylesheet" href="/static/layui/css/layui.css">
    <script src="/static/layui/layui.js"></script>
    <script src="/static/js/jquery.js"></script>
</head>
<body>
<blockquote class="layui-elem-quote">
    <div class="demoTable">
        搜索电影名称：
        <div class="layui-inline">
            <input class="layui-input" name="name" id="demoReload" autocomplete="off">
        </div>
        <button class="layui-btn layui-bg-blue" data-type="reload" id="search">搜索</button>
        <div class="layui-btn-group demoTableSon">
            <button class="layui-btn layui-btn-danger" data-type="deleteByIds" id="deleteByIds">删除</button>
        </div>
    </div>
</blockquote>
<table class="layui-hide" id="test" lay-filter="table"></table>
<script type="text/html" id="barDemo">
    <a class="layui-btn layui-btn-xs" lay-event="edit">编辑</a>
    <a class="layui-btn layui-btn-danger layui-btn-xs" lay-event="del">删除</a>
</script>
<script type="text/html" id="imageTpl">
    <div class="layer-photos-demo" onclick="imageClick()" style="cursor:pointer;">
        <img  layer-pid="" layer-src="/static/fileImages/{{d.imageName}}" src="/static/fileImages/{{d.imageName}}" alt="图片名">
    </div>;
</script>
<script type="text/html" id="hotTpl">
    {{# if(d.hot == 1){  }}
        <p color="blue">是</p>
    {{# }else{             }}
         <p color="blue">否</p>
    {{#      }      }}
</script>

<script type="text/javascript">
    layui.use(['layer','table','form','upload','element'],function () {
        var layer = layui.layer;
        var table = layui.table;
        var form = layui.layer;
        var upload = layui.layer;
        var element = layui.element;
        function randomNumber() {
            return Math.ceil(Math.random()*6);
        }
        function imageClick(){
            layer.photos({
                photos:'.layer-photos-demo',
                anim:randomNumber()
            });
        }
        table.render({
            elem:"#test",
            url:"/admin/film/filmList",
            cols:[[
                {type:'checkbox'},
                {field:'id',title:'编号'},
                {field:'imageName',title:'电影图片',templet: '#imageTpl'},
                {field:'name',title:'电影名称'},
                {field:'hot',title:'是否热门',templet: '#hotTpl'},
                {field:'publishDate',title:'发布日期'},
                {fixed: 'right',title: '操作', width:180, align:'center', toolbar: '#barDemo'}  //绑定tpl表达式
            ]],
            page:true,//开启分页
            id:'testReload', //这个id挺重要的  你对table做操作时候需要使用到  比如reload的时候
            limits:[5,10,15,20],
            limit:10,
            done:function (res,curr,count) {
                imageClick();
            }
        });

        table.on('tool(table)',function (obj) {
            var data = obj.data;
            var layEvent = obj.event;
            if(layEvent === 'del'){
                var id = data.id;
                layer.confirm("您真的确定要删除这行数据吗？",function (index) {
                    $.ajax({
                        async:false,
                        cache:false,
                        url:'/admin/film/deleteById',
                        type:'post',
                        dataType:"json",
                        data: {id:id},
                        success:function (result) {
                            if(result.success){
                                obj.del();
                                layer.close(index);
                                layer.msg("系统提示，删除成功", { icon: 6 });
                            }else{
                                layer.msg("系统提示，删除失败，请联系管理员", { icon: 5});
                            }
                        },
                        error:function (XMLHttpRequest, textStatus) {
                            layer.alert("状态码: "+XMLHttpRequest.status +" 错误信息: "+ textStatus);
                        }
                    });
                });
            }else if(layEvent === 'edit'){
                // 调用父类的这种想法失败了 还没失败，再尝试一下
                var a = $("#testParentDom", parent.document).click();
                var filter = a.attr("lay-filter");
                parent.addEditFilm(data.id);
            }
        });

        var active = {
            reload:function () {
                var demoRelaod = $('#demoReload').val();
                console.log(demoRelaod);
                //执行重载
                table.reload('testReload',{
                    page:{
                        curr : 1
                    },
                    where:{
                        name:demoRelaod
                    }
                });
            },
            deleteByIds : function () {
                var checkStatus =  table.checkStatus('testReload'),
                    data = checkStatus.data;
                var strIds = [];
                for(var i=0;i<data.length;i++){
                    strIds.push(data[i].id);
                }
                var ids = strIds.join(",");
                console.log(ids);
                layer.confirm("您确定要删除这"+data.length+"条数据吗？",function (index) {
                    $.ajax({
                        async:false,
                        cache:false,
                        url:'/admin/film/delete',
                        type:'POST',
                        dataType:"json",
                        data: {ids:ids},
                        success:function (result) {
                            if(result.success){
                                layer.close(index);
                                table.reload('testReload');
                                parent.layer.msg("系统提示，操作成功", { icon: 6 });
                            }else{
                                parent.layer.msg("系统提示，添加失败，请联系管理员", { icon: 5});
                            }
                        },
                        error:function (XMLHttpRequest, textStatus) {
                            layer.alert("状态码: "+XMLHttpRequest.status +" 错误信息: "+ textStatus);
                        }
                    });
                });
            }
        };

        $('#search').on('click',function () {
            var type = $(this).data('type');
            active[type] ? active[type].call(this) : '';
        });

        $('#deleteByIds').on('click',function () {
            var type = $(this).data('type');
            active[type] ? active[type].call(this) : '';
        });

    });
</script>
</body>
</html>